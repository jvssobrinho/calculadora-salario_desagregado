<script>
let dadosJSON = null;
const ARQUIVO_JSON = 'modelo_salario_ocupacao_nomes_reais.json';

// ===============================
// 1. CARREGA JSON
// ===============================
fetch(ARQUIVO_JSON)
    .then(res => {
        if (!res.ok) throw new Error("Arquivo JSON não encontrado");
        return res.json();
    })
    .then(data => {
        dadosJSON = data;
        atualizarDropdownOcupacoes();
    })
    .catch(err => {
        alert("Erro crítico: " + err.message);
    });

// ===============================
// 2. DROPDOWN DE OCUPAÇÕES
// ===============================
function atualizarDropdownOcupacoes() {
    if (!dadosJSON) return;

    const select = document.getElementById('ocupacao');
    const coef = dadosJSON.coeficientes;

    let listaOcupacoes = [];

    listaOcupacoes.push({ valor: "BASE", texto: "OUTRAS / OCUPAÇÕES ELEMENTARES (BASE)" });

    for (let chave in coef) {
        if (chave.startsWith('ocup_')) {
            let texto = chave.replace('ocup_', '');

            if (texto.includes(' - ')) {
                let [codigo, nome] = texto.split(' - ');
                texto = `${nome} (Cód. ${codigo})`;
            }

            listaOcupacoes.push({ valor: chave, texto });
        }
    }

    listaOcupacoes.sort((a, b) => a.texto.localeCompare(b.texto));

    select.innerHTML = '';
    select.disabled = false;

    let optDefault = document.createElement('option');
    optDefault.text = "Selecione sua profissão...";
    optDefault.value = "";
    optDefault.disabled = true;
    optDefault.selected = true;
    select.add(optDefault);

    listaOcupacoes.forEach(o => {
        let opt = document.createElement('option');
        opt.value = o.valor;
        opt.text = o.texto;
        select.add(opt);
    });
}

// ===============================
// 3. CÁLCULO DO SALÁRIO
// ===============================
function calcularSalario() {
    if (!dadosJSON) return alert("Aguarde o carregamento dos dados");

    const raca = document.getElementById('cor').value;
    const idade = +document.getElementById('idade').value;
    const anosEstudo = +document.getElementById('estudo').value;
    const sexo = document.getElementById('sexo').value;
    const uf = document.getElementById('uf').value;
    const ocupacao = document.getElementById('ocupacao').value;

    if (!ocupacao) return alert("Selecione uma profissão");

    const coef = dadosJSON.coeficientes;
    const meta = dadosJSON.meta_info;

    let experiencia = Math.max(0, idade - anosEstudo - 6);
    let experiencia2 = experiencia ** 2;

    // -------- MINCER --------
    let lnSalario = coef['Intercepto'];

    if (coef['Anos_Estudo']) lnSalario += coef['Anos_Estudo'] * anosEstudo;
    if (coef['Experiencia']) lnSalario += coef['Experiencia'] * experiencia;
    if (coef['Experiencia_2']) lnSalario += coef['Experiencia_2'] * experiencia2;

    // Dummy mulher
    if (sexo === 'mulher' && coef['d_mulher']) {
        lnSalario += coef['d_mulher'];
    }

    // Dummy racial (base = branca)
    if (raca === 'preta' && coef['d_preto_pardo']) {
        lnSalario += coef['d_preto_pardo'];
    }

    if (coef[`UF_${uf}`]) lnSalario += coef[`UF_${uf}`];
    if (coef['IMR']) lnSalario += coef['IMR'] * 0.6;

    if (ocupacao !== "BASE" && coef[ocupacao]) {
        lnSalario += coef[ocupacao];
    }

    // Log → R$
    let salario = Math.exp(lnSalario) * 180;
    let sigma = meta.sigma_log || 0.65;

    let min = Math.exp(lnSalario - 1.96 * sigma) * 180;
    let max = Math.exp(lnSalario + 1.96 * sigma) * 180;

    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

    document.getElementById('valorEstimado').innerText = fmt.format(salario);
    document.getElementById('faixaMin').innerText = fmt.format(min);
    document.getElementById('faixaMax').innerText = fmt.format(max);

    const nomesRaca = {
        branca: 'População Branca',
        amarela: 'População Amarela',
        preta: 'População Preta/Parda',
        indigena: 'População Indígena'
    };

    document.getElementById('infoModelo').innerText =
        `Modelo Estatístico: ${nomesRaca[raca]} (N=${meta.N})`;

    const sel = document.getElementById('ocupacao');
    document.getElementById('badgeProfissao').innerText =
        sel.options[sel.selectedIndex].text.split('(')[0];

    document.getElementById('resultado').style.display = 'block';
}
</script>
